<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Project Voxel-Level Data using a HATSA Projector — project_voxels.hatsa_projector • hatsa</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Project Voxel-Level Data using a HATSA Projector — project_voxels.hatsa_projector"><meta name="description" content="Projects voxel-level time series data into the common aligned space defined
by a hatsa_projector object. This method uses Nyström extension."><meta property="og:description" content="Projects voxel-level time series data into the common aligned space defined
by a hatsa_projector object. This method uses Nyström extension."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">hatsa</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/core-hatsa-toy-example.html">Core HATSA with a Toy-Connectome</a></li>
    <li><a class="dropdown-item" href="../articles/getting-started.html">Getting Started with HATSA</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/bbuchsbaum/hatsa/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Project Voxel-Level Data using a HATSA Projector</h1>
      <small class="dont-index">Source: <a href="https://github.com/bbuchsbaum/hatsa/blob/main/R/voxel_projection.R" class="external-link"><code>R/voxel_projection.R</code></a></small>
      <div class="d-none name"><code>project_voxels.hatsa_projector.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Projects voxel-level time series data into the common aligned space defined
by a <code>hatsa_projector</code> object. This method uses Nyström extension.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="co"># S3 method for class 'hatsa_projector'</span></span>
<span><span class="fu"><a href="project_voxels.html">project_voxels</a></span><span class="op">(</span></span>
<span>  <span class="va">object</span>,</span>
<span>  <span class="va">voxel_timeseries_list</span>,</span>
<span>  <span class="va">voxel_coords</span>,</span>
<span>  <span class="va">parcel_coords</span>,</span>
<span>  n_nearest_parcels <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  kernel_sigma <span class="op">=</span> <span class="st">"auto"</span>,</span>
<span>  W_vox_parc <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  data_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"timeseries"</span>, <span class="st">"coefficients"</span><span class="op">)</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-object">object<a class="anchor" aria-label="anchor" href="#arg-object"></a></dt>
<dd><p>A fitted <code>hatsa_projector</code> object.</p></dd>


<dt id="arg-voxel-timeseries-list">voxel_timeseries_list<a class="anchor" aria-label="anchor" href="#arg-voxel-timeseries-list"></a></dt>
<dd><p>A list of voxel time-series matrices (T_i x V_v).
It is assumed that the i-th element of this list corresponds to the i-th
subject as stored in the <code>hatsa_projector</code> object (e.g., for U_original_list).</p></dd>


<dt id="arg-voxel-coords">voxel_coords<a class="anchor" aria-label="anchor" href="#arg-voxel-coords"></a></dt>
<dd><p>A numeric matrix (V_v x 3) of voxel coordinates.</p></dd>


<dt id="arg-parcel-coords">parcel_coords<a class="anchor" aria-label="anchor" href="#arg-parcel-coords"></a></dt>
<dd><p>A numeric matrix (V_p x 3) of parcel centroid coordinates
corresponding to the parcellation used to fit the <code>object</code>.</p></dd>


<dt id="arg-n-nearest-parcels">n_nearest_parcels<a class="anchor" aria-label="anchor" href="#arg-n-nearest-parcels"></a></dt>
<dd><p>Integer, number of nearest parcels for Nyström extension.
Passed to <code><a href="compute_voxel_basis_nystrom.html">compute_voxel_basis_nystrom</a></code>.</p></dd>


<dt id="arg-kernel-sigma">kernel_sigma<a class="anchor" aria-label="anchor" href="#arg-kernel-sigma"></a></dt>
<dd><p>Numeric or "auto", kernel bandwidth for Nyström extension.
Passed to <code><a href="compute_voxel_basis_nystrom.html">compute_voxel_basis_nystrom</a></code>.</p></dd>


<dt id="arg-w-vox-parc">W_vox_parc<a class="anchor" aria-label="anchor" href="#arg-w-vox-parc"></a></dt>
<dd><p>Optional pre-computed voxel-to-parcel affinity matrix
(V_v x V_p). If provided, this matrix is reused for all subjects and the
internal k-NN search and Gaussian kernel calculation are skipped. If
<code>NULL</code> (default), the affinity matrix is computed once using
<code>n_nearest_parcels</code> and <code>kernel_sigma</code> and then reused.</p></dd>


<dt id="arg-data-type">data_type<a class="anchor" aria-label="anchor" href="#arg-data-type"></a></dt>
<dd><p>Character string, either "timeseries" (default) or
"coefficients". If "timeseries", the projection involves scaling by `1/T_i`
(number of time points) to estimate covariance with the basis.
If "coefficients" (e.g., for projecting beta maps or statistical maps),
this scaling is omitted.</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>Additional arguments passed to <code><a href="compute_voxel_basis_nystrom.html">compute_voxel_basis_nystrom</a></code>.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A list of aligned voxel coefficient matrices. Each element `[[i]]` is a
  matrix of dimensions T_i x k, where T_i is the number of time points (or rows)
  in the input `voxel_timeseries_list[[i]]`, and k is the number of HATSA components.
  These represent the projection coefficients of the voxel data onto the aligned
  HATSA basis for each subject.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>It is assumed that <code>voxel_coords</code> and <code>parcel_coords</code> are in the
same Cartesian coordinate system and units (e.g., millimeters in an MNI-aligned space).
The function includes heuristic checks for gross inconsistencies in these coordinate
systems (see <code>.<a href="dot-validate_coordinate_inputs.html">.validate_coordinate_inputs</a></code> for details on checks performed),
issuing messages if potential issues like substantially different ranges or scales are detected.
The Nyström extension is formulated to be consistent with the unnormalized graph
Laplacian used in the core HATSA algorithm for parcel-level decomposition. See
<code><a href="compute_voxel_basis_nystrom.html">compute_voxel_basis_nystrom</a></code> for more details on parameters like
<code>row_normalize_W</code> that control the Nyström calculation.</p>
    </div>
    <div class="section level2">
    <h2 id=""></h2>
    <p>NA</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co"># This is a conceptual example. For it to run, you need a fitted hatsa_projector.</span></span></span>
<span class="r-in"><span><span class="co"># First, let's set up parameters for a minimal run_hatsa_core call.</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">456</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">N_subj_fit</span> <span class="op">&lt;-</span> <span class="fl">2</span></span></span>
<span class="r-in"><span><span class="va">V_parc_fit</span> <span class="op">&lt;-</span> <span class="fl">20</span> <span class="co"># Number of parcels in the fitted model</span></span></span>
<span class="r-in"><span><span class="va">k_comp_fit</span> <span class="op">&lt;-</span> <span class="fl">3</span>   <span class="co"># Number of components in the fitted model</span></span></span>
<span class="r-in"><span><span class="va">T_time_fit</span> <span class="op">&lt;-</span> <span class="fl">40</span>  <span class="co"># Number of time points for parcel data</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Generate mock parcel-level data for fitting HATSA</span></span></span>
<span class="r-in"><span><span class="va">subject_parcel_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">N_subj_fit</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">T_time_fit</span> <span class="op">*</span> <span class="va">V_parc_fit</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="va">V_parc_fit</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">anchor_idx_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">V_parc_fit</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">V_parc_fit</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Fit a hatsa_projector object (requires Matrix and RSpectra)</span></span></span>
<span class="r-in"><span><span class="va">fitted_hatsa_model</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"Matrix"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">&amp;&amp;</span> </span></span>
<span class="r-in"><span>    <span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"RSpectra"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">&amp;&amp;</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="https://rdrr.io/r/base/exists.html" class="external-link">exists</a></span><span class="op">(</span><span class="st">"run_hatsa_core"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="va">fitted_hatsa_model</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span><span class="op">{</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="run_hatsa_core.html">run_hatsa_core</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>      subject_data_list <span class="op">=</span> <span class="va">subject_parcel_data</span>,</span></span>
<span class="r-in"><span>      anchor_indices    <span class="op">=</span> <span class="va">anchor_idx_fit</span>,</span></span>
<span class="r-in"><span>      spectral_rank_k <span class="op">=</span> <span class="va">k_comp_fit</span>,</span></span>
<span class="r-in"><span>      k_conn_pos        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fl">5</span>, <span class="va">V_parc_fit</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>      k_conn_neg        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fl">2</span>, <span class="va">V_parc_fit</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>      n_refine          <span class="op">=</span> <span class="fl">1</span></span></span>
<span class="r-in"><span>    <span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="op">}</span>, error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="cn">NULL</span><span class="op">)</span> <span class="co"># Return NULL on error for example</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">fitted_hatsa_model</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="co"># Now, prepare data for project_voxels</span></span></span>
<span class="r-in"><span>  <span class="va">N_subj_proj</span> <span class="op">&lt;-</span> <span class="va">N_subj_fit</span> <span class="co"># Number of subjects for voxel projection</span></span></span>
<span class="r-in"><span>  <span class="va">V_vox_proj</span>  <span class="op">&lt;-</span> <span class="fl">50</span>         <span class="co"># Number of voxels</span></span></span>
<span class="r-in"><span>  <span class="va">T_time_vox</span>  <span class="op">&lt;-</span> <span class="fl">35</span>         <span class="co"># Number of time points for voxel data</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co"># Mock voxel time-series data</span></span></span>
<span class="r-in"><span>  <span class="va">voxel_ts_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">N_subj_proj</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">T_time_vox</span> <span class="op">*</span> <span class="va">V_vox_proj</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="va">V_vox_proj</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="op">}</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co"># Mock coordinates</span></span></span>
<span class="r-in"><span>  <span class="va">voxel_coords_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">V_vox_proj</span> <span class="op">*</span> <span class="fl">3</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="co"># Parcel coords must match the V_p used when fitting the model</span></span></span>
<span class="r-in"><span>  <span class="va">parcel_coords_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">V_parc_fit</span> <span class="op">*</span> <span class="fl">3</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> </span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co"># Project voxel data</span></span></span>
<span class="r-in"><span>  <span class="va">projected_vox_coeffs</span> <span class="op">&lt;-</span> <span class="fu"><a href="project_voxels.html">project_voxels</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>    object <span class="op">=</span> <span class="va">fitted_hatsa_model</span>,</span></span>
<span class="r-in"><span>    voxel_timeseries_list <span class="op">=</span> <span class="va">voxel_ts_list</span>,</span></span>
<span class="r-in"><span>    voxel_coords <span class="op">=</span> <span class="va">voxel_coords_map</span>,</span></span>
<span class="r-in"><span>    parcel_coords <span class="op">=</span> <span class="va">parcel_coords_map</span>,</span></span>
<span class="r-in"><span>    n_nearest_parcels <span class="op">=</span> <span class="fl">5</span>, <span class="co"># Nystrom param</span></span></span>
<span class="r-in"><span>    kernel_sigma <span class="op">=</span> <span class="st">"auto"</span>    <span class="co"># Nystrom param</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co"># print(str(projected_vox_coeffs, max.level=1))</span></span></span>
<span class="r-in"><span>  <span class="co"># if (length(projected_vox_coeffs) &gt; 0) {</span></span></span>
<span class="r-in"><span>  <span class="co">#   print(dim(projected_vox_coeffs[[1]])) # Should be T_time_vox x k_comp_fit</span></span></span>
<span class="r-in"><span>  <span class="co"># }</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/interactive.html" class="external-link">interactive</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"Skipping project_voxels example: fitted_hatsa_model not created."</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Brad Buchsbaum.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

