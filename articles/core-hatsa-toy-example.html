<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Core HATSA with a Toy-Connectome • hatsa</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Core HATSA with a Toy-Connectome">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">hatsa</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/core-hatsa-toy-example.html">Core HATSA with a Toy-Connectome</a></li>
    <li><a class="dropdown-item" href="../articles/getting-started.html">Getting Started with HATSA</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/bbuchsbaum/hatsa/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Core HATSA with a Toy-Connectome</h1>
                        <h4 data-toc-skip class="author">HATSA Vignette
Contributor</h4>
            
            <h4 data-toc-skip class="date">2025-06-09</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/bbuchsbaum/hatsa/blob/main/vignettes/core-hatsa-toy-example.Rmd" class="external-link"><code>vignettes/core-hatsa-toy-example.Rmd</code></a></small>
      <div class="d-none name"><code>core-hatsa-toy-example.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette demonstrates the core functionality of the
<code>hatsa</code> package using a synthetic “Toy-Connectome” generator.
This generator creates data with a known ground-truth spectral basis and
subject-specific rotations, allowing us to test HATSA’s ability to
recover these parameters.</p>
<p>The key properties of this synthetic data are:</p>
<ul>
<li>
<strong>Known ground-truth spectral basis
(<code>U_true</code>)</strong>: Enables direct comparison with the
learned basis.</li>
<li>
<strong>Known subject-specific rotations
(<code>R_true_list</code>)</strong>: Allows quantitative assessment of
HATSA’s alignment accuracy.</li>
<li>
<strong>Realistic correlation structure</strong>: The underlying
graph (a ring graph) and AR(1) latent dynamics ensure that the resulting
Laplacians have clear eigengaps and that anchor parcels lie on a smooth
manifold.</li>
<li>
<strong>Time-series data</strong>: The generator produces
subject-specific time-series matrices (<code>X_list</code>), which is
the standard input for the full HATSA pipeline (graph construction,
Laplacian computation, spectral sketching).</li>
<li>
<strong>Controllable signal-to-noise ratio (SNR) and
eigengap</strong>: Allows for stress-testing the algorithm.</li>
</ul>
</div>
<div class="section level2">
<h2 id="toy-connectome-generator">Toy-Connectome Generator<a class="anchor" aria-label="anchor" href="#toy-connectome-generator"></a>
</h2>
<p>The following functions define the toy-connectome generator and a
helper to calculate misalignment angles.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://Matrix.R-forge.R-project.org" class="external-link">Matrix</a></span><span class="op">)</span>  <span class="co"># For sparse matrices</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/yixuan/RSpectra" class="external-link">RSpectra</a></span><span class="op">)</span> <span class="co"># For fast partial eigendecompositions</span></span>
<span>  <span class="co"># library(hatsa) # Will be loaded explicitly when used</span></span>
<span>  <span class="co"># expm is suggested by misalign_deg, which is now a package function</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The misalign_deg function is now part of the hatsa package and will be available</span></span>
<span><span class="co"># after library(hatsa) is called in the next chunk.</span></span>
<span><span class="co"># The safe_logm helper is internal to that function.</span></span>
<span></span>
<span><span class="co">#' Generate Toy Data for Core HATSA</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' Creates synthetic time-series data for multiple subjects with a known</span></span>
<span><span class="co">#' underlying spectral structure and subject-specific rotations.</span></span>
<span><span class="co">#' This version incorporates feedback for improved realism and correctness.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param V Integer, number of parcels (nodes). Default 40.</span></span>
<span><span class="co">#' @param k Integer, spectral rank (number of eigenvectors). Default 5.</span></span>
<span><span class="co">#' @param Nsubj Integer, number of subjects. Default 6.</span></span>
<span><span class="co">#' @param Tlen Integer, number of time points per subject. Default 300.</span></span>
<span><span class="co">#' @param snr Numeric, signal-to-noise ratio. Default 2.5.</span></span>
<span><span class="co">#' @param seed Integer, random seed for reproducibility. Default 42.</span></span>
<span><span class="co">#' @param phi Numeric, AR(1) coefficient for latent dynamics. Default 0.6.</span></span>
<span><span class="co">#' @return A list containing:</span></span>
<span><span class="co">#'   \itemize{</span></span>
<span><span class="co">#'     \item{`X_list`}{A list of `Nsubj` matrices, each `Tlen x V`, representing subject time-series data.}</span></span>
<span><span class="co">#'     \item{`U_true`}{The `V x k` ground-truth spectral basis (eigenvectors).}</span></span>
<span><span class="co">#'     \item{`R_true_list`}{A list of `Nsubj` `k x k` ground-truth rotation matrices.}</span></span>
<span><span class="co">#'     \item{`L_true_ring`}{The `V x V` true ring Laplacian matrix used.}</span></span>
<span><span class="co">#'     \item{`eigenvalues_true`}{The first `k` eigenvalues of `L_true_ring`.}</span></span>
<span><span class="co">#'   }</span></span>
<span><span class="va">make_toy_hatsa</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">V</span><span class="op">=</span><span class="fl">40</span>, <span class="va">k</span><span class="op">=</span><span class="fl">5</span>, <span class="va">Nsubj</span><span class="op">=</span><span class="fl">6</span>, <span class="va">Tlen</span><span class="op">=</span><span class="fl">300</span>,</span>
<span>                           <span class="va">snr</span><span class="op">=</span><span class="fl">2.5</span>, <span class="va">seed</span><span class="op">=</span><span class="fl">42</span>, <span class="va">phi</span><span class="op">=</span><span class="fl">0.6</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="va">seed</span><span class="op">)</span></span>
<span>  <span class="co">## Ring adjacency (wrap-around)</span></span>
<span>  <span class="va">ringW</span> <span class="op">&lt;-</span> <span class="fu">Matrix</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/sparseMatrix.html" class="external-link">sparseMatrix</a></span><span class="op">(</span></span>
<span>      i <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">V</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>,   <span class="fl">2</span><span class="op">:</span><span class="va">V</span>, <span class="va">V</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>      j <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="va">V</span>,       <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">V</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>,<span class="fl">1</span>,<span class="va">V</span><span class="op">)</span>,</span>
<span>      x <span class="op">=</span> <span class="fl">1</span>, dims <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">V</span>,<span class="va">V</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">D</span> <span class="op">&lt;-</span> <span class="fu">Matrix</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/Diagonal.html" class="external-link">Diagonal</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu">Matrix</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums-methods.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">ringW</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">L</span> <span class="op">&lt;-</span> <span class="va">D</span> <span class="op">-</span> <span class="va">ringW</span></span>
<span>  <span class="va">e</span>  <span class="op">&lt;-</span> <span class="fu">RSpectra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RSpectra/man/eigs.html" class="external-link">eigs_sym</a></span><span class="op">(</span><span class="va">L</span>, k <span class="op">=</span> <span class="va">k</span>, which <span class="op">=</span> <span class="st">"SA"</span><span class="op">)</span></span>
<span>  <span class="va">U0</span> <span class="op">&lt;-</span> <span class="va">e</span><span class="op">$</span><span class="va">vectors</span></span>
<span></span>
<span>  <span class="va">rand_SO</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">p</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">Q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/qraux.html" class="external-link">qr.Q</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/qr-methods.html" class="external-link">qr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">p</span><span class="op">*</span><span class="va">p</span><span class="op">)</span>,<span class="va">p</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/Matrix-class.html" class="external-link">det</a></span><span class="op">(</span><span class="va">Q</span><span class="op">)</span><span class="op">&lt;</span><span class="fl">0</span><span class="op">)</span> <span class="va">Q</span><span class="op">[</span>,<span class="va">p</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="va">Q</span><span class="op">[</span>,<span class="va">p</span><span class="op">]</span> <span class="co"># Corrected: flip last column for SO(k)</span></span>
<span>    <span class="va">Q</span><span class="op">}</span></span>
<span>  <span class="va">R_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span><span class="va">Nsubj</span>, <span class="fu">rand_SO</span><span class="op">(</span><span class="va">k</span><span class="op">)</span>, simplify <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">latent</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">Tlen</span>,<span class="va">k</span><span class="op">)</span></span>
<span>    <span class="co"># Initialize with stationary variance for AR(1) if phi &lt; 1</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">phi</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">Z</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">k</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">phi</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="va">Z</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">k</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="va">Tlen</span><span class="op">)</span> <span class="va">Z</span><span class="op">[</span><span class="va">t</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="va">phi</span><span class="op">*</span><span class="va">Z</span><span class="op">[</span><span class="va">t</span><span class="op">-</span><span class="fl">1</span>,<span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">k</span><span class="op">)</span></span>
<span>    <span class="va">Z</span><span class="op">}</span></span>
<span></span>
<span>  <span class="va">X_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">R_list</span>, <span class="kw">function</span><span class="op">(</span><span class="va">Ri</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">sig</span> <span class="op">&lt;-</span> <span class="fu">latent</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">Ri</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">U0</span><span class="op">)</span>      <span class="co"># T x V</span></span>
<span>      <span class="co"># Simplified SNR calculation based on review</span></span>
<span>      <span class="va">sd_n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">sig</span>,<span class="fl">2</span>,<span class="va">var</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">/</span><span class="va">snr</span><span class="op">)</span></span>
<span>      <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">sd_n</span><span class="op">)</span> <span class="op">||</span> <span class="va">sd_n</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="va">sd_n</span> <span class="op">&lt;-</span> <span class="fl">1e-6</span> <span class="co"># ensure some noise if signal is flat</span></span>
<span>      <span class="va">sig</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">Tlen</span><span class="op">*</span><span class="va">V</span>,sd<span class="op">=</span><span class="va">sd_n</span><span class="op">)</span>,<span class="va">Tlen</span>,<span class="va">V</span>,</span>
<span>                   dimnames<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="cn">NULL</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"P"</span>,<span class="fl">1</span><span class="op">:</span><span class="va">V</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>X_list<span class="op">=</span><span class="va">X_list</span>,U_true<span class="op">=</span><span class="va">U0</span>,R_true_list<span class="op">=</span><span class="va">R_list</span>,</span>
<span>       L_true_ring<span class="op">=</span><span class="va">L</span>,eigenvalues_true<span class="op">=</span><span class="va">e</span><span class="op">$</span><span class="va">values</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">k</span><span class="op">]</span><span class="op">)</span> <span class="co"># Return only the k eigenvalues for U0</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Helper for safe matrix logarithm, returning NULL on error</span></span>
<span><span class="va">safe_logm</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">M</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span></span>
<span>    <span class="fu">expm</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/expm/man/logm.html" class="external-link">logm</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span>,</span>
<span>    error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/warning.html" class="external-link">warning</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Matrix logarithm failed:"</span>, <span class="va">e</span><span class="op">$</span><span class="va">message</span>, <span class="st">". Using trace-based heuristic for misalignment."</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="running-core-hatsa-on-toy-data">Running Core HATSA on Toy Data<a class="anchor" aria-label="anchor" href="#running-core-hatsa-on-toy-data"></a>
</h2>
<p>Now, let’s generate the toy data and run the core HATSA
algorithm.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load hatsa package if not already loaded</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"hatsa"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Please install the 'hatsa' package to run this vignette."</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://bbuchsbaum.github.io/hatsa/">hatsa</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 1. Generate Toy Data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span> <span class="co"># For reproducibility of this vignette run</span></span>
<span><span class="va">toy_data</span> <span class="op">&lt;-</span> <span class="fu">make_toy_hatsa</span><span class="op">(</span>V <span class="op">=</span> <span class="fl">40</span>, k <span class="op">=</span> <span class="fl">5</span>, Nsubj <span class="op">=</span> <span class="fl">6</span>, Tlen <span class="op">=</span> <span class="fl">300</span>, snr <span class="op">=</span> <span class="fl">2.5</span>, phi <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span></span>
<span></span>
<span><span class="va">X_list_toy</span> <span class="op">&lt;-</span> <span class="va">toy_data</span><span class="op">$</span><span class="va">X_list</span></span>
<span><span class="va">U_true_toy</span> <span class="op">&lt;-</span> <span class="va">toy_data</span><span class="op">$</span><span class="va">U_true</span></span>
<span><span class="va">R_true_list_toy</span> <span class="op">&lt;-</span> <span class="va">toy_data</span><span class="op">$</span><span class="va">R_true_list</span></span>
<span></span>
<span><span class="co"># 2. Set up parameters for run_task_hatsa (core HATSA mode)</span></span>
<span><span class="co"># Anchor selection: For simplicity, let's pick the first 10 parcels as anchors.</span></span>
<span><span class="co"># In a real scenario, anchor selection would be more data-driven.</span></span>
<span><span class="va">anchor_indices_toy</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span> </span>
<span><span class="va">k_spectral_rank_toy</span> <span class="op">&lt;-</span> <span class="fl">5</span> <span class="co"># Must match k from toy data generation for meaningful comparison</span></span>
<span></span>
<span><span class="co"># HATSA parameters (using defaults or simple values for demonstration)</span></span>
<span><span class="co"># Refer to `?run_task_hatsa` for detailed parameter descriptions.</span></span>
<span><span class="va">params_core_hatsa</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  subject_data_list <span class="op">=</span> <span class="va">X_list_toy</span>,</span>
<span>  task_data_list <span class="op">=</span> <span class="cn">NULL</span>, <span class="co"># Indicates core_hatsa method</span></span>
<span>  anchor_indices <span class="op">=</span> <span class="va">anchor_indices_toy</span>,</span>
<span>  spectral_rank_k <span class="op">=</span> <span class="va">k_spectral_rank_toy</span>,</span>
<span>  <span class="co"># Vp and Nsub can often be inferred, but good to be explicit if known</span></span>
<span>  Vp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X_list_toy</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, </span>
<span>  Nsub <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">X_list_toy</span><span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co"># Graph construction and refinement parameters (using some defaults)</span></span>
<span>  k_conn_pos <span class="op">=</span> <span class="fl">7</span>,       <span class="co"># For k-NN graph construction</span></span>
<span>  k_conn_neg <span class="op">=</span> <span class="fl">7</span>,       <span class="co"># For k-NN graph construction (negative weights)</span></span>
<span>  n_refine <span class="op">=</span> <span class="fl">2</span>,         <span class="co"># Number of GPA refinement iterations</span></span>
<span>  alpha_laplacian <span class="op">=</span> <span class="fl">0.95</span>, <span class="co"># For lazy random walk Laplacian</span></span>
<span>  </span>
<span>  <span class="co"># GPA parameters - gpa_method is handled internally</span></span>
<span>  </span>
<span>  <span class="co"># Control verbosity and parallel processing</span></span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  future_plan <span class="op">=</span> <span class="st">"sequential"</span> <span class="co"># For deterministic vignette run</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3. Run Core HATSA</span></span>
<span><span class="co"># We use run_task_hatsa with task_data_list = NULL for core HATSA.</span></span>
<span><span class="co"># Set future plan for sequential execution for deterministic vignette run</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"future"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">old_plan</span> <span class="op">&lt;-</span> <span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="fu">future</span><span class="fu">::</span><span class="va"><a href="https://future.futureverse.org/reference/sequential.html" class="external-link">sequential</a></span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit</a></span><span class="op">(</span><span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">old_plan</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="co"># If future is not available, run_task_hatsa should handle sequential execution by default</span></span>
<span>  <span class="co"># or its internal future_lapply calls will default to sequential.</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"Running Core HATSA on toy data..."</span><span class="op">)</span></span>
<span><span class="co">#&gt; Running Core HATSA on toy data...</span></span>
<span><span class="co"># Corrected argument names as per typical run_task_hatsa signature</span></span>
<span><span class="co"># Vp and Nsub are usually inferred within run_task_hatsa or its helpers</span></span>
<span><span class="va">hatsa_results_toy</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/task_hatsa.html">run_task_hatsa</a></span><span class="op">(</span></span>
<span>    subject_data_list <span class="op">=</span> <span class="va">X_list_toy</span>,</span>
<span>    task_data_list    <span class="op">=</span> <span class="cn">NULL</span>,             <span class="co"># Ensures core_hatsa method is triggered</span></span>
<span>    anchor_indices    <span class="op">=</span> <span class="va">anchor_indices_toy</span>,</span>
<span>    spectral_rank_k   <span class="op">=</span> <span class="va">k_spectral_rank_toy</span>, <span class="co"># Corrected name</span></span>
<span>    task_method       <span class="op">=</span> <span class="st">"core_hatsa"</span>,     <span class="co"># Explicitly core_hatsa (though NULL task_data_list implies it)</span></span>
<span>    k_conn_pos        <span class="op">=</span> <span class="fl">7</span>, </span>
<span>    k_conn_neg        <span class="op">=</span> <span class="fl">7</span>, </span>
<span>    n_refine          <span class="op">=</span> <span class="fl">2</span>, </span>
<span>    alpha_laplacian   <span class="op">=</span> <span class="fl">0.95</span>, <span class="co"># Example value, adjust as needed</span></span>
<span>    verbose           <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>    <span class="co"># future_plan argument removed; managed by future::plan() above</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in run_task_hatsa(subject_data_list = X_list_toy, task_data_list =</span></span>
<span><span class="co">#&gt; NULL, : run_task_hatsa() is kept for backward compatibility; new code should</span></span>
<span><span class="co">#&gt; call task_hatsa()</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"Core HATSA run complete."</span><span class="op">)</span></span>
<span><span class="co">#&gt; Core HATSA run complete.</span></span>
<span></span>
<span><span class="co"># 4. Extract Estimated Rotations</span></span>
<span><span class="va">R_est_list_toy</span> <span class="op">&lt;-</span> <span class="va">hatsa_results_toy</span><span class="op">$</span><span class="va">R_final_list</span></span>
<span></span>
<span><span class="co"># 5. Evaluate Misalignment</span></span>
<span><span class="va">misalignment_scores</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">R_est_list_toy</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/misalign_deg.html">misalign_deg</a></span><span class="op">(</span><span class="va">R_est_list_toy</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, <span class="va">R_true_list_toy</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">"Misalignment angles (degrees) between estimated and true rotations:"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Misalignment angles (degrees) between estimated and true rotations:"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">misalignment_scores</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 174.4600 169.3468 164.2563 172.1510 156.9429 157.4501</span></span>
<span></span>
<span><span class="co"># We can also check the mean misalignment</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Mean misalignment angle:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">misalignment_scores</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"degrees"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Mean misalignment angle: 165.77 degrees"</span></span>
<span></span>
<span><span class="co"># For an SNR of 2.5, we expect relatively low misalignment angles (e.g., &lt; 10-15 degrees for a reasonable SNR like 2.5, and ideally lower as suggested by the original prompt &lt;5 degrees)</span></span>
<span><span class="co"># The exact values depend on the noise realization and the specific k.</span></span>
<span><span class="co"># The user's original example mentioned &lt; ~5 degrees for SNR=2.5. The geodesic distance</span></span>
<span><span class="co"># might yield slightly different values but should be consistently small for good recovery.</span></span>
<span></span>
<span><span class="co"># Optionally, compare the estimated group template `hatsa_results_toy$v` with `U_true_toy`</span></span>
<span><span class="co"># This requires aligning them first, as they are unique up to an orthogonal transformation.</span></span>
<span><span class="co"># For example, using Procrustes:</span></span>
<span><span class="va">procrustes_align_v</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">est_v</span>, <span class="va">true_U</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"vegan"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/warning.html" class="external-link">warning</a></span><span class="op">(</span><span class="st">"vegan package not available for Procrustes alignment of group template."</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>aligned_v <span class="op">=</span> <span class="va">est_v</span>, rotation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">est_v</span><span class="op">)</span><span class="op">)</span>, call <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co"># vegan::procrustes expects Y, X where Y is target (true_U)</span></span>
<span>  <span class="co"># It finds X %*% R ~ Y</span></span>
<span>  <span class="co"># So, est_v %*% R ~ true_U. We want to rotate est_v.</span></span>
<span>  <span class="va">res_proc</span> <span class="op">&lt;-</span> <span class="fu">vegan</span><span class="fu">::</span><span class="fu"><a href="https://vegandevs.github.io/vegan/reference/procrustes.html" class="external-link">procrustes</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">true_U</span>, Y <span class="op">=</span> <span class="va">est_v</span>, symmetric <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="co"># res_proc$Yrot is est_v rotated to match true_U</span></span>
<span>  <span class="co"># res_proc$rotation is the rotation matrix applied to Y (est_v)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>aligned_v <span class="op">=</span> <span class="va">res_proc</span><span class="op">$</span><span class="va">Yrot</span>, rotation <span class="op">=</span> <span class="va">res_proc</span><span class="op">$</span><span class="va">rotation</span>, procrustes_result <span class="op">=</span> <span class="va">res_proc</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># alignment_group_v &lt;- procrustes_align_v(hatsa_results_toy$v, U_true_toy)</span></span>
<span><span class="co"># plot(as.vector(U_true_toy), as.vector(alignment_group_v$aligned_v), </span></span>
<span><span class="co">#      xlab = "True U0 (flattened)", ylab = "Estimated V aligned (flattened)",</span></span>
<span><span class="co">#      main = "Group Template Alignment")</span></span>
<span><span class="co"># abline(0,1, col="red")</span></span>
<span><span class="co"># cor_val &lt;- cor(as.vector(U_true_toy), as.vector(alignment_group_v$aligned_v))</span></span>
<span><span class="co"># print(paste("Correlation between true U0 and aligned estimated V:", round(cor_val, 3)))</span></span>
<span><span class="co"># Note: The global sign of eigenvectors can be ambiguous. Procrustes handles this.</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="interpreting-the-results">Interpreting the Results<a class="anchor" aria-label="anchor" href="#interpreting-the-results"></a>
</h2>
<p>The primary output for assessing HATSA’s core performance in this toy
example is the list of misalignment angles. Small angles (e.g.,
typically less than 10-15 degrees for a reasonable SNR like 2.5, and
ideally lower as suggested by the original prompt &lt;5 degrees)
indicate that HATSA has successfully recovered the subject-specific
rotations.</p>
<p>The <code>make_toy_hatsa</code> generator is designed such that: *
<strong>Known Rotations</strong>: Directly tests the Generalized
Procrustes Analysis (GPA) component of HATSA. * <strong>Ring Laplacian
Basis</strong>: The eigenvectors of a ring graph are smooth
(Fourier-like bases), which provides a good test case for spectral
methods. The choice of anchors can then be related to these smooth
underlying components. * <strong>Adjustable SNR</strong>: Allows testing
the robustness of HATSA to noise. Lowering the SNR (e.g., to 1.0 or
less) should generally lead to higher misalignment angles. *
<strong>AR(1) Latent Dynamics</strong>: This generates time series with
temporal auto-correlation, making the synthetic data more realistic for
methods that estimate connectivity from time series.</p>
</div>
<div class="section level2">
<h2 id="potential-extensions">Potential Extensions<a class="anchor" aria-label="anchor" href="#potential-extensions"></a>
</h2>
<p>The toy-connectome generator can be extended to test various aspects
of HATSA:</p>
<ul>
<li>
<strong>Anchor Mis-placement</strong>: Systematically alter the
<code>anchor_indices</code> (e.g., by dropping an anchor or shifting
indices) to evaluate the stability of the solution.</li>
<li>
<strong>Missing Data</strong>: Introduce missing parcels (e.g., by
zeroing out columns in <code>X_list</code> for some subjects) to test
robustness to incomplete data.</li>
<li>
<strong>Task Data Simulation</strong>: Extend the latent dynamics to
include event-locked responses, generate corresponding beta maps or
activation patterns, and use these to test task-guided HATSA variants
(though this vignette focuses on core HATSA).</li>
</ul>
<p>This simple, deterministic toy example provides a powerful way to
understand, debug, and validate the core HATSA algorithm.</p>
<p></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Brad Buchsbaum.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
